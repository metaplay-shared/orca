import{d as pe,E as oe,c as H,a as j,o as h,q as z,m as C,t as R,k as P,j as g,f as _,D as ze,y as xe,bz as Ce,af as Oe,h as F,cg as se,eb as $e,K as ie,ch as Ne,bs as ke,bH as le,r as q,e as D,w as p,x as De,_ as G,F as re,b as ue,Q as Pe,ae as ce,bE as Se,bt as Ae}from"./index-DAyiym1a.js";import{b as de,c as te,M as Q,a as X}from"./metaListUtils-B-xQ0HnD.js";import{a as we,g as Ee}from"./localization-DDIHoN6I.js";import{C as Ie}from"./CoreUiPlacement-Q0Nbc6Vr.js";import{M as Me}from"./MSingleColumnLayout-CUJDqBPP.js";import{_ as je}from"./MInputSingleSelectSwitch.vue_vue_type_script_setup_true_lang-dEvjQEX9.js";import{_ as fe}from"./MRawDataCard.vue_vue_type_script_setup_true_lang-Q1r46_CP.js";import{_ as Re,a as Te}from"./MViewContainer.vue_vue_type_script_setup_true_lang-DP4T6epC.js";import{_ as me}from"./MInputSingleSelectDropdown.vue_vue_type_script_setup_true_lang-BRIBVSuX.js";import"./index-TQG-La0y.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-B7AbTbVm.js";class Ve{diff(t,a,o={}){let i;typeof o=="function"?(i=o,o={}):"callback"in o&&(i=o.callback);const m=this.castInput(t,o),w=this.castInput(a,o),u=this.removeEmpty(this.tokenize(m,o)),l=this.removeEmpty(this.tokenize(w,o));return this.diffWithOptionsObj(u,l,o,i)}diffWithOptionsObj(t,a,o,i){var m;const w=c=>{if(c=this.postProcess(c,o),i){setTimeout(function(){i(c)},0);return}else return c},u=a.length,l=t.length;let y=1,v=u+l;o.maxEditLength!=null&&(v=Math.min(v,o.maxEditLength));const U=(m=o.timeout)!==null&&m!==void 0?m:1/0,M=Date.now()+U,L=[{oldPos:-1,lastComponent:void 0}];let S=this.extractCommon(L[0],a,t,0,o);if(L[0].oldPos+1>=l&&S+1>=u)return w(this.buildValues(L[0].lastComponent,a,t));let A=-1/0,E=1/0;const W=()=>{for(let c=Math.max(A,-y);c<=Math.min(E,y);c+=2){let T;const V=L[c-1],K=L[c+1];V&&(L[c-1]=void 0);let $=!1;if(K){const J=K.oldPos-c;$=K&&0<=J&&J<u}const Y=V&&V.oldPos+1<l;if(!$&&!Y){L[c]=void 0;continue}if(!Y||$&&V.oldPos<K.oldPos?T=this.addToPath(K,!0,!1,0,o):T=this.addToPath(V,!1,!0,1,o),S=this.extractCommon(T,a,t,c,o),T.oldPos+1>=l&&S+1>=u)return w(this.buildValues(T.lastComponent,a,t))||!0;L[c]=T,T.oldPos+1>=l&&(E=Math.min(E,c-1)),S+1>=u&&(A=Math.max(A,c+1))}y++};if(i)(function c(){setTimeout(function(){if(y>v||Date.now()>M)return i(void 0);W()||c()},0)})();else for(;y<=v&&Date.now()<=M;){const c=W();if(c)return c}}addToPath(t,a,o,i,m){const w=t.lastComponent;return w&&!m.oneChangePerToken&&w.added===a&&w.removed===o?{oldPos:t.oldPos+i,lastComponent:{count:w.count+1,added:a,removed:o,previousComponent:w.previousComponent}}:{oldPos:t.oldPos+i,lastComponent:{count:1,added:a,removed:o,previousComponent:w}}}extractCommon(t,a,o,i,m){const w=a.length,u=o.length;let l=t.oldPos,y=l-i,v=0;for(;y+1<w&&l+1<u&&this.equals(o[l+1],a[y+1],m);)y++,l++,v++,m.oneChangePerToken&&(t.lastComponent={count:1,previousComponent:t.lastComponent,added:!1,removed:!1});return v&&!m.oneChangePerToken&&(t.lastComponent={count:v,previousComponent:t.lastComponent,added:!1,removed:!1}),t.oldPos=l,y}equals(t,a,o){return o.comparator?o.comparator(t,a):t===a||!!o.ignoreCase&&t.toLowerCase()===a.toLowerCase()}removeEmpty(t){const a=[];for(let o=0;o<t.length;o++)t[o]&&a.push(t[o]);return a}castInput(t,a){return t}tokenize(t,a){return Array.from(t)}join(t){return t.join("")}postProcess(t,a){return t}get useLongestToken(){return!1}buildValues(t,a,o){const i=[];let m;for(;t;)i.push(t),m=t.previousComponent,delete t.previousComponent,t=m;i.reverse();const w=i.length;let u=0,l=0,y=0;for(;u<w;u++){const v=i[u];if(v.removed)v.value=this.join(o.slice(y,y+v.count)),y+=v.count;else{if(!v.added&&this.useLongestToken){let U=a.slice(l,l+v.count);U=U.map(function(M,L){const S=o[y+L];return S.length>M.length?S:M}),v.value=this.join(U)}else v.value=this.join(a.slice(l,l+v.count));l+=v.count,v.added||(y+=v.count)}}return i}}class Be extends Ve{constructor(){super(...arguments),this.tokenize=Ue}equals(t,a,o){return o.ignoreWhitespace?((!o.newlineIsToken||!t.includes(`
`))&&(t=t.trim()),(!o.newlineIsToken||!a.includes(`
`))&&(a=a.trim())):o.ignoreNewlineAtEof&&!o.newlineIsToken&&(t.endsWith(`
`)&&(t=t.slice(0,-1)),a.endsWith(`
`)&&(a=a.slice(0,-1))),super.equals(t,a,o)}}const Fe=new Be;function qe(I,t,a){return Fe.diff(I,t,a)}function Ue(I,t){t.stripTrailingCr&&(I=I.replace(/\r\n/g,`
`));const a=[],o=I.split(/(\n|\r\n)/);o[o.length-1]||o.pop();for(let i=0;i<o.length;i++){const m=o[i];i%2&&!t.newlineIsToken?a[a.length-1]+=m:a.push(m)}return a}const We={class:"tw-py-1"},Ke={class:"tw-font-semibold"},Je={class:"tw-text-xs"},Ye={key:0,class:"tw-text-xs"},ve=pe({__name:"LocalizationSelectOption",props:{localizationId:{}},setup(I){const t=I,{data:a}=oe(we()),o=H(()=>(a.value??[]).find(i=>i.id===t.localizationId));return(i,m)=>(h(),j("div",We,[z("p",Ke,R(o.value?.name||"No Name Available"),1),z("p",Je,R(i.localizationId),1),o.value?(h(),j("p",Ye,[m[0]||(m[0]=P("Built ",-1)),g(_(xe),{instant:_(ze).fromISO(o.value.buildStartedAt),disableTooltip:""},null,8,["instant"])])):C("",!0)]))}}),Ge={class:"tw-flex tw-flex-col tw-items-center tw-justify-between @lg:tw-flex-row"},He={class:"tw-w-full"},Qe={class:"text-right tw-w-full tw-text-xs"},Xe={class:"tw-w-full"},Ze={class:"text-right tw-w-full tw-text-xs"},et={class:"tw-flex tw-items-center tw-justify-between"},tt=["id","onClick"],ot={class:"font-weight-bold mr-2"},nt={key:3,class:"tw-ml-1 tw-text-xs tw-text-blue-400"},at={key:4,class:"mt-2"},st={class:"diff text-monospace"},it={key:0},lt={key:1},rt={class:"added"},ut={key:2},ct={class:"removed"},Lt=pe({__name:"LocalizationDiffView",setup(I){const t=ke(),a=Ce(),o=Oe(),{data:i}=oe(Ee("$active")),{data:m}=oe(we()),w={},u=F(se(a.query,"baselineRoot")),l=F(se(a.query,"newRoot"));$e(async()=>{await Promise.all([M(u.value),M(l.value)])}),ie(u,async()=>{A.value=c(u.value),A.value||await M(u.value),y()}),ie(l,async()=>{E.value=c(l.value),E.value||await M(l.value),y()}),Ne(()=>{i.value&&(w[i.value.info.id]=i.value,u.value??=i.value.info.id,l.value??=i.value.info.id)});function y(){const e=(a.path+`?baselineRoot=${u.value}&newRoot=${l.value}`).split("?"),d=e[0],N=Object.fromEntries(e[1].split("&").map(O=>O.split("=")));o.replace({path:d,query:N}).catch(O=>{if(O instanceof Error&&O.name!=="NavigationDuplicated")throw Error(O.message)})}const{showSuccessNotification:v}=Ae();function U(){const n=u.value;u.value=l.value,l.value=n,v("Localizations swapped.")}async function M(n){if(n!==void 0&&L.value!=="Error"&&w[n]===void 0){L.value="Loading",w[n]=null;try{const d=(await t.get(`/localization/${n}`)).data;d.info.bestEffortStatus!=="Success"?(S.value=new le(`Failed to load diff source ${n}`,`The status of the localization was ${d.info.bestEffortStatus}, expected status was Success. You can't compare against this localization because it failed to build.`),L.value="Error"):(w[n]=d,L.value!=="Error"&&!Object.values(w).some(N=>N==null)&&(A.value=c(u.value),E.value=c(l.value),L.value="Loaded"))}catch(e){S.value=new le("Oh no, something went wrong while trying to compare two localizations:",e.message),L.value="Error"}}}const L=F("Loading"),S=F(),A=F(),E=F(),W=H(()=>{const n=A.value,e=E.value;if(!n||!e)return[];const d=[],N=Object.keys(e),O=Object.keys(n);return N.forEach(r=>{const x=e[r]??null,b=n[r]??null;if(x===null){b&&d.push({anchorName:`${r}-whole-library`,displayName:r,languageName:r,itemName:"",reason:"Added"});return}b!==null&&Object.keys(x).forEach(f=>{Object.prototype.hasOwnProperty.call(b,f)||d.push({anchorName:`${r}-${f}`,displayName:`${r}.${f}`,languageName:r,itemName:f,reason:"Added"})})}),O.forEach(r=>{const x=n[r]??null,b=e[r]??null;if(x===null){b&&d.push({anchorName:`${r}-whole-library`,displayName:r,languageName:r,itemName:"",reason:"Removed"});return}b!==null&&Object.keys(x).forEach(f=>{Object.prototype.hasOwnProperty.call(b,f)||d.push({anchorName:`${r}-${f}`,displayName:`${r}.${f}`,languageName:r,itemName:f,reason:"Removed"})})}),O.forEach(r=>{const x=n[r]??null,b=e[r]??null;!x||!b||Object.keys(x).forEach(f=>{if(Object.prototype.hasOwnProperty.call(b,f)){const B=JSON.stringify(x[f]),s=JSON.stringify(b[f]);B!==s&&(!B.startsWith('"#missing#')||!s.startsWith('"#missing#'))&&d.push({anchorName:`${r}-${f}`,displayName:`${r}.${f}`,languageName:r,itemName:f,reason:"Modified"})}})}),d.sort((r,x)=>{const b=r.anchorName.toLowerCase(),f=x.anchorName.toLowerCase();return b<f?-1:b>f?1:0}),d});function c(n){const e=w[n??""];if(e){const d={};return Object.entries(e.locs).forEach(([N,O])=>{d[N]=O.translations}),d}else return}function T(n,e){let d={};Object.prototype.hasOwnProperty.call(A.value?.[n],e)&&(d=A.value?.[n][e]);let N={};Object.prototype.hasOwnProperty.call(E.value?.[n],e)&&(N=E.value?.[n][e]);const O=V(d),r=V(N),x=qe(O,r),b=[];return x.forEach(f=>{let B="Unchanged";f.added?B="Added":f.removed&&(B="Removed");const s=f.value.split(/\r?\n/).slice(0,f.count);b.push(...s.map(ee=>{const k=ee.split(":")[0],ae=k.replace(/"/g,""),Le=ee.replace(k,ae);return{reason:B,text:Le}}))}),b}function V(n){return typeof n=="string"?`  "${n}"`:typeof n=="number"?`  ${n}`:Object.keys(n).length===0?" ":JSON.stringify(n,(e,d)=>d,2).slice(2,-2)}const K=[{label:"Baseline",value:"Baseline"},{label:"Full Diff",value:"Diff"},{label:"Only Additions",value:"Additions"},{label:"New",value:"Destination"}],$=F("Diff");function Y(n){return $.value==="Diff"||$.value==="Additions"&&n!=="Removed"||$.value==="Baseline"&&n!=="Added"?!0:$.value==="Destination"&&n!=="Removed"}const J=F([]);function he(n){const e=J.value.indexOf(n);e===-1?J.value.push(n):J.value.splice(e,1)}function Z(n){return!J.value.includes(n)}const _e=H(()=>[de.asDynamicFilterSet(W.value,"library",n=>n.languageName),new de("reason",[new te("Modified",n=>n.reason==="Modified"),new te("Added",n=>n.reason==="Added"),new te("Removed",n=>n.reason==="Removed")])]),ye=[new Q("Name","displayName",X.Ascending),new Q("Name","displayName",X.Descending),new Q("Reason","reason",X.Ascending),new Q("Reason","reason",X.Descending)],be=H(()=>u.value===l.value?"You are comparing a localization version against itself. Unsurprisingly, this means that there are no differences to be found 🤔":"No differences found between the two localization versions 🤔"),ne=H(()=>ge.value.map(n=>{const e=m.value?.find(d=>d.id===n);return{label:`${n} - ${e?.name||"No Name Available"}`,value:n}})),ge=H(()=>(m.value??[]).filter(n=>n.bestEffortStatus==="Success"&&!n.isArchived).map(n=>n.id));return(n,e)=>{const d=q("fa-icon"),N=q("meta-list-card"),O=q("b-card-title"),r=q("b-card-body"),x=q("meta-lazy-loader"),b=q("b-list-group-item"),f=q("b-list-group"),B=q("b-card");return h(),D(_(Te),{permission:"api.localization.view","is-loading":!_(i)||!_(m),error:S.value,"full-width-overview":""},{overview:p(()=>[g(_(Re),{title:"Compare Game Config Versions",subtitle:"Select two localizations to compare the differences between them. You can view the differences in the full diff, or filter them to only show additions, removals, or modifications."},{default:p(()=>[z("div",Ge,[z("div",He,[g(_(me),{label:"Baseline Localization","model-value":u.value,options:ne.value,"onUpdate:modelValue":e[0]||(e[0]=s=>u.value=s)},{option:p(({option:s})=>[s.value?(h(),D(ve,{key:0,localizationId:s.value},null,8,["localizationId"])):C("",!0)]),_:1},8,["model-value","options"]),z("div",Qe,[g(_(ce),{to:`/localizations/${u.value}`},{default:p(()=>e[3]||(e[3]=[P("View baseline localization",-1)]),void 0,!0),_:1,__:[3]},8,["to"])])]),g(_(Se),{class:"tw-m-4","aria-label":"Swap the baseline and new localizations.",onClick:U},{default:p(()=>[g(d,{icon:"right-left"})],void 0,!0),_:1}),z("div",Xe,[g(_(me),{label:"New Localization","model-value":l.value,options:ne.value,"onUpdate:modelValue":e[1]||(e[1]=s=>l.value=s)},{option:p(({option:s})=>[s.value?(h(),D(ve,{key:0,localizationId:s.value},null,8,["localizationId"])):C("",!0)]),_:1},8,["model-value","options"]),z("div",Ze,[g(_(ce),{to:`/localizations/${l.value}`},{default:p(()=>e[4]||(e[4]=[P("View new localization",-1)]),void 0,!0),_:1,__:[4]},8,["to"])])])])],void 0,!0),_:1})]),default:p(()=>[g(Ie,{placementId:"Localizations/Diff"}),g(_(Me),{class:"tw-mb-5"},{default:p(()=>[g(N,{title:"Overview of changes",itemList:L.value==="Loading"?void 0:W.value,searchFields:["displayName"],filterSets:_e.value,sortOptions:ye,emptyMessage:be.value,"page-size":15},{"item-card":p(s=>[g(_(De),null,{default:p(()=>[s.item.reason==="Added"?(h(),D(_(G),{key:0,class:"mr-2",variant:"success",tooltip:"Added"},{default:p(()=>e[5]||(e[5]=[P("A",-1)]),void 0,!0),_:1,__:[5]})):C("",!0),s.item.reason==="Removed"?(h(),D(_(G),{key:1,class:"mr-2",variant:"danger",tooltip:"Removed"},{default:p(()=>e[6]||(e[6]=[P("R",-1)]),void 0,!0),_:1,__:[6]})):C("",!0),s.item.reason==="Modified"?(h(),D(_(G),{key:2,class:"mr-2",variant:"primary",tooltip:"Modified"},{default:p(()=>e[7]||(e[7]=[P("M",-1)]),void 0,!0),_:1,__:[7]})):C("",!0),z("span",null,R(s.item.displayName),1)],void 0,!0),_:2},1024)]),_:1},8,["itemList","filterSets","emptyMessage"])],void 0,!0),_:1}),W.value.length>0?(h(),D(B,{key:0,class:"shadow-sm mb-3 tw-mx-3","no-body":""},{default:p(()=>[g(r,null,{default:p(()=>[z("div",et,[g(O,{class:"tw-pt-3"},{default:p(()=>e[8]||(e[8]=[P("Detailed Changes",-1)]),void 0,!0),_:1,__:[8]}),g(_(je),{"model-value":$.value,options:K,"onUpdate:modelValue":e[2]||(e[2]=s=>$.value=s)},null,8,["model-value"])])],void 0,!0),_:1}),g(f,{class:"list-group-stripes",flush:""},{default:p(()=>[(h(!0),j(re,null,ue(W.value,(s,ee)=>(h(),D(b,{key:s.anchorName},{default:p(()=>[g(x,{renderAfterDelayInMs:50},{default:p(()=>[z("div",{id:s.anchorName,style:{cursor:"pointer"},onClick:k=>he(s.anchorName)},[z("span",{class:Pe({"not-collapsed":!Z(s.anchorName)})},[Y(s.reason)?(h(),D(d,{key:0,class:"mr-2",icon:"angle-right"})):C("",!0)],2),z("span",ot,R(s.languageName)+R(s.itemName!==""?".":"")+R(s.itemName),1),s.reason==="Added"?(h(),D(_(G),{key:0,variant:"success"},{default:p(()=>e[9]||(e[9]=[P("Added",-1)]),void 0,!0),_:1,__:[9]})):C("",!0),s.reason==="Removed"?(h(),D(_(G),{key:1,variant:"danger"},{default:p(()=>e[10]||(e[10]=[P("Removed",-1)]),void 0,!0),_:1,__:[10]})):C("",!0),s.reason==="Modified"?(h(),D(_(G),{key:2,variant:"primary"},{default:p(()=>e[11]||(e[11]=[P("Modified",-1)]),void 0,!0),_:1,__:[11]})):C("",!0),Y(s.reason)?(h(),j("span",nt,R(Z(s.anchorName)?"Show":"Hide"),1)):C("",!0),!Z(s.anchorName)&&Y(s.reason)?(h(),j("div",at,[(h(!0),j(re,null,ue(T(s.languageName,s.itemName),(k,ae)=>(h(),j("div",st,[["Diff","Baseline","Destination"].includes($.value)&&k.reason=="Unchanged"?(h(),j("div",it,R(k.text),1)):C("",!0),["Diff","Additions","Destination"].includes($.value)&&k.reason=="Added"?(h(),j("div",lt,[e[12]||(e[12]=z("span",{class:"text-success"},"+",-1)),e[13]||(e[13]=P()),z("span",rt,R(k.text.slice(2,k.text.length)),1)])):["Diff","Baseline"].includes($.value)&&k.reason=="Removed"?(h(),j("div",ut,[e[14]||(e[14]=z("span",{class:"text-danger"},"-",-1)),e[15]||(e[15]=P()),z("span",ct,R(k.text.slice(2,k.text.length)),1)])):C("",!0)]))),256))])):C("",!0)],8,tt)],void 0,!0),_:2},1024)],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})],void 0,!0),_:1})):C("",!0),g(_(fe),{data:A.value,label:"baselineLocalization"},null,8,["data"]),g(_(fe),{data:E.value,label:"newLocalization"},null,8,["data"])],void 0,!0),_:1},8,["is-loading","error"])}}});export{Lt as default};
