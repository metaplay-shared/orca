import{d as R,E as q,h as d,c as H,r as U,e as g,o as u,I as z,w as y,j as _,f as r,q as i,m as E,a as k,a6 as $,k as c,F as J,b as L,t as P,bl as W,_ as Y,bH as x,cG as N,bs as K,bt as Q}from"./index-DAyiym1a.js";import{a as X}from"./players-CkgXyjra.js";import{_ as Z}from"./MInputTextArea.vue_vue_type_script_setup_true_lang-Dxjs9C9J.js";import{_ as ee}from"./MInputSingleFileContents.vue_vue_type_script_setup_true_lang-CGbk44sq.js";import{_ as ae}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CRnsCPt_.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-B7AbTbVm.js";import"./debounce-CRuraxcR.js";import"./isSymbol-BXvDeGRF.js";import"./MInputSingleFile-DNpEs77W.js";import"./MActionModal.vue_vue_type_script_setup_true_lang-XDUxofmt.js";import"./index-CVSO09yM.js";const te={class:"tw-mb-2"},re={class:"tw-mr-1"},le={key:3},oe={class:"code-box text-monospace border rounded bg-light tw-w-full",style:{"max-height":"20.3rem"}},be=R({__name:"PlayerActionOverwrite",props:{playerId:{}},setup(T){const V=T,C=K(),{data:v,refresh:j}=q(X(V.playerId)),n=d(""),s=d(),l=d(),b=d(!1),w=d(),o=d(),h=d(),p=H(()=>{const t=n.value!==""||s.value;return!t||t&&!o.value&&!l.value?null:!!(l.value&&b.value)});function D(t){n.value=t,A(t)}function F(t){s.value=t,A(t)}function S(){n.value="",s.value=void 0,l.value=void 0,b.value=!1,o.value=void 0}async function A(t){if(o.value=void 0,l.value=void 0,w.value=void 0,b.value=!1,t){let e;try{e=O(t)}catch(a){o.value=new x("Calculating payload failed",a.message);return}try{h.value&&h.value.cancel("Request canceled by user interaction."),h.value=N.CancelToken.source();const a=(await C.post(`/players/${v.value.id}/validateOverwrite`,e,{cancelToken:h.value.token})).data;a.error?o.value=new x("Validation failed",a.error.message,500,void 0,[{title:"Details",content:a.error.details}]):a.data.diff===""?l.value=`No differences in player model data.
Did you paste in the correct player?`:(l.value=a.data.diff,b.value=!0)}catch(a){N.isCancel(a)||a.response&&(o.value=new x("Validaiton failed",a.response.data.error.message))}}}const{showSuccessNotification:G}=Q();async function I(t){const e=O(t);await C.post(`/players/${v.value.id}/importOverwrite`,e),G("Player import succeeded."),j()}function O(t){let e;try{e=JSON.parse(t)}catch(f){throw new Error(`Could not parse archive. Got '${f.message}'.`)}if(typeof e!="object")throw new Error(`Entity archive must be an object. Got '${typeof e}'.`);if(Array.isArray(e))throw new Error("Entity archive must be an object. Got 'array'.");if(!("entities"in e))throw new Error("Entity archive must contain entities but none found.");if(!("player"in e.entities))throw new Error("Entity archive must contain player entities but none found.");const a=Object.keys(e.entities.player);if(a.length!==1)throw new Error(`Entity archive may only contain exactly one player entity. Got ${a.length}.`);const m=Object.keys(e.entities).filter(f=>f!=="player");m.forEach(f=>delete e.entities[f]),m.length&&(w.value=m);const B=a[0],M=v.value.id;return e.remaps={player:{}},e.remaps.player[B]=M,e}return(t,e)=>{const a=U("meta-no-seatbelts");return u(),g(r(ae),{"trigger-button-disabled-tooltip":r(v)?"":"Waiting for player data..","modal-title":"Overwrite Player",action:()=>I(s.value??n.value),"trigger-button-label":"Overwrite Player",variant:"danger","ok-button-label":"Overwrite Player","ok-button-disabled-tooltip":p.value?void 0:"Paste in or upload a valid player to proceed.",permission:"api.players.overwrite",onShow:S,onHidden:S,"data-testid":"action-overwrite-player"},z({default:y(()=>[e[2]||(e[2]=i("h6",{class:"tw-mb-1"},"Paste Player Data",-1)),i("p",te,[e[0]||(e[0]=c("You can copy & paste the serialized data of a compatible player here to overwrite parts of ",-1)),_(r(Y),null,{default:y(()=>[c(P(r(v).model.playerName||"n/a"),1)],void 0,!0),_:1}),e[1]||(e[1]=c(".",-1))]),e[3]||(e[3]=i("p",{class:"tw-mb-4"},[c("This is an "),i("span",{class:"tw-text-danger"},"advanced development feature"),c(" and should probably never be used in production!")],-1)),_(r(Z),{class:"tw-mb-2",label:"Paste in an archive...","model-value":n.value,placeholder:s.value!=null?"File upload selected":"{'entities':{'player':...",variant:p.value!==null?p.value?"success":"danger":"default",rows:5,disabled:!!s.value,"onUpdate:modelValue":D,"data-testid":"entity-archive-text"},null,8,["model-value","placeholder","variant","disabled"]),_(r(ee),{label:"...or upload a file...","model-value":s.value,placeholder:n.value!==""?"Manual paste selected":"Choose or drop an entity archive file",variant:p.value!==null?p.value?"success":"danger":"default",disabled:n.value!=="","accepted-file-types":".json","onUpdate:modelValue":F,"data-testid":"entity-archive-file"},null,8,["model-value","placeholder","variant","disabled"])]),"right-panel":y(()=>[e[6]||(e[6]=i("h6",{class:"tw-mb-4"},"Preview Incoming Data",-1)),w.value?(u(),g(r($),{key:0,class:"tw-mb-2",title:"Extra Entity Types",variant:"warning"},{default:y(()=>[i("p",null,[e[4]||(e[4]=c("Archive contained the following extra entity types that were removed: ",-1)),(u(!0),k(J,null,L(w.value,m=>(u(),k("span",re,P(m),1))),256))])],void 0,!0),_:1})):E("",!0),!l.value&&!o.value?(u(),g(r($),{key:1,class:"tw-mb-2",title:"Preview",variant:"neutral"},{default:y(()=>e[5]||(e[5]=[c("Paste in a valid player from a compatible game version to preview what data will be copied over.",-1)]),void 0,!0),_:1,__:[5]})):E("",!0),o.value?(u(),g(r(W),{key:2,class:"tw-mb-2",error:o.value},null,8,["error"])):E("",!0),l.value?(u(),k("div",le,[i("div",oe,[i("pre",null,P(l.value),1)])])):E("",!0)]),_:2},[p.value?{name:"bottom-panel",fn:y(()=>[_(a,{class:"tw-mx-auto tw-w-7/12",name:r(v).model.playerName||"n/a"},null,8,["name"])]),key:"0"}:void 0]),1032,["trigger-button-disabled-tooltip","action","ok-button-disabled-tooltip"])}}});export{be as default};
