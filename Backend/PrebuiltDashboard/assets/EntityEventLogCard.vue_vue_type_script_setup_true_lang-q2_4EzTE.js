import{d as L,E as $,c as r,h as y,i as K,cn as q,K as M,bs as b,b7 as F,e as G,o as H,f as A}from"./index-DAyiym1a.js";import{E as B,a as R,b as z,w as N,g as V,M as W}from"./MetaEventStreamCard-BshWTCEs.js";import{A as g}from"./apiPoller-B0M_RdYo.js";import{g as O}from"./analyticsEvents-BaCdc4qs.js";import{k as U}from"./keyBy-CW6TLeGB.js";const Z=L({__name:"EntityEventLogCard",props:{title:{default:void 0},entityKind:{},entityId:{},entityResetTimestamp:{default:null},utilitiesMode:{default:"filter"},searchPreHighlight:{default:""},freezeSearch:{type:Boolean},keywordPreFilters:{default:()=>[]},eventTypePreFilters:{default:()=>[]},maxHeight:{default:"30rem"},fetchPollingInterval:{default:5e3},fetchPageSize:{default:1e3},folding:{default:"session"},showViewMoreLink:{type:Boolean,default:!0},excludedTypes:{default:()=>[]},wrapRepeatingEvents:{type:Boolean,default:!0}},emits:["stats"],setup(h,{emit:E}){const P=F(),S=b(),t=h,I=E,{data:T}=$(O()),k=r(()=>U(T.value,e=>e.type.split(",")[0]));let l,c,s,f;const o=y(!1);K(async()=>{D.value?await v():o.value=!1}),q(()=>{l?.stop(),s?.stop()});const u=r(()=>{let e="";if(typeof t.entityId=="string"?e=t.entityId:e=t.entityId(),!e)throw new Error("Entity Id cannot be empty or undefined.");return e});M([()=>u.value,()=>t.entityResetTimestamp],async()=>{await v()});const p=r(()=>{if(t.entityKind==="Player")return`/players/${u.value}/eventLog`;if(t.entityKind==="Guild")return`/guilds/${u.value}/eventLog`;throw new Error("Invalid entityKind for EntityEventLogCard: "+t.entityKind)}),i=y([]),d=y(!1);async function v(){d.value=!1,i.value=[],o.value=!0,l&&(l.stop(),l=void 0),s&&(s.stop(),s=void 0);const e=(await S.request({method:"GET",url:p.value,params:{startCursor:"$newest",numEntries:1,scanDirection:"towardsNewer"}})).data;if(e.failedWithDesync)throw new Error("Initial request from cursor $newest should never result in a desync.");const n=e.startCursor;c=n,f=n,l=new g(()=>t.fetchPollingInterval,"GET",p.value,()=>({startCursor:c,numEntries:t.fetchPageSize,scanDirection:"towardsNewer"}),a=>{d.value=!0,a.failedWithDesync?v():(a.entries.length>0&&(i.value=i.value.concat(a.entries),m()),c=a.continuationCursor)}),s=new g(100,"GET",p.value,()=>({startCursor:f,numEntries:t.fetchPageSize,scanDirection:"towardsOlder"}),a=>{d.value=!0,a.failedWithDesync?v():(a.entries.length>0&&(i.value=a.entries.concat(i.value),m(),f=a.continuationCursor),a.entries.length<t.fetchPageSize&&(s?.stop(),o.value=!1))})}const C=r(()=>{if(i.value.length>0){let e=i.value.filter(n=>!t.excludedTypes.includes(n.payload.$type)).map(n=>new B(n.collectedAt,k.value[n.payload.$type]?.displayName||n.payload.$type,n.payload.eventDescription,n.uniqueId,n,"","timeline",`/entityEventLog/${t.entityKind}/${u.value}?search=${n.uniqueId}`));return t.folding==="session"?e=R(e):t.folding==="day"&&(e=z(e)),t.wrapRepeatingEvents&&(e=N(e)),I("stats",V(e)),e}else return d.value?[]:null});function m(){if(i.value.length>0)for(let e=1;e<i.value.length;e++)i.value[e].sequentialId!==i.value[e-1].sequentialId+1&&console.warn(`Gap in event log: entry ${i.value[e].sequentialId} follows ${i.value[e-1].sequentialId}`)}const D=r(()=>P.doesHavePermission(w.value)),w=r(()=>{if(t.entityKind==="Player")return"api.players.view";if(t.entityKind==="Guild")return"api.guilds.view";throw new Error("Invalid entityKind for EntityEventLogCard: "+t.entityKind)});return(e,n)=>(H(),G(A(W),{title:e.title??`Latest ${e.entityKind} Events`,icon:"clipboard-list",eventStream:C.value,eventStreamLoading:o.value,utilitiesMode:e.utilitiesMode,searchPreHighlight:e.searchPreHighlight,keywordPreFilters:e.keywordPreFilters,eventTypePreFilters:e.eventTypePreFilters,maxHeight:e.maxHeight,permission:w.value,showTimeDeltas:e.folding!=="day",showViewMoreLink:e.showViewMoreLink,"allow-pausing":"","data-testid":"entity-event-log-card"},null,8,["title","eventStream","eventStreamLoading","utilitiesMode","searchPreHighlight","keywordPreFilters","eventTypePreFilters","maxHeight","permission","showTimeDeltas","showViewMoreLink"]))}});export{Z as _};
