import{d as L,c as y,cM as $,cN as N,cO as X,cP as q,D,e as f,a as F,o as m,bo as Y,bp as U,bq as E,br as K,f as p,E as R,b7 as G,h as Q,bH as J,K as z,ah as Z,I as ee,w,q as B,t as P,m as H,Q as _,ae as O,k as C}from"./index-DAyiym1a.js";import{a as M}from"./numberUtils-CkF0oMe2.js";import{b as S,_ as j}from"./MPlot.vue_vue_type_script_setup_true_lang-Bt9zzkvn.js";const te={key:1,class:"tw-p-4 tw-text-center tw-italic tw-text-neutral-500"},W=L({__name:"MTimeSeriesBarChart",props:{chartOptions:{}},setup(i){const a=i,l={data:[],interval:"minute",xTickFormat:"%H:%M",yTickFormat:"s",xDomain:void 0,yMinValue:10,tooltipContent:void 0,height:void 0,hideXAxisLabels:!1,unit:"",valueHighlightThreshold:void 0},e=y(()=>({...l,...a.chartOptions})),d=o=>({primary:"#2d90dc",neutral:"#d4d4d4",success:"#10b981",danger:"#ef4444",warning:"#f59e0b"})[o],n=y(()=>{const o=e.value.data.map(t=>t.value).filter(t=>t!=null),c=o.length>0?Math.max(...o):0,r=[$({ticks:e.value.hideXAxisLabels?[]:[e.value.data[0].instant],label:null,tickFormat:t=>`${t.toFormat(`yyyy-MM-dd
HH:mm`)} UTC`,textAnchor:"start"}),$({ticks:e.value.hideXAxisLabels?[]:[e.value.data[e.value.data.length-1].instant],label:null,tickFormat:t=>`${t.toFormat(`yyyy-MM-dd
HH:mm`)} UTC`,textAnchor:"end"}),N(e.value.data.filter(t=>t.value!==null),X({x:"instant",y:.5*c>e.value.yMinValue?.5*c:.5*e.value.yMinValue,title:e.value.tooltipContent??(t=>`${t.value} ${e.value.unit}
${t.instant.toFormat("yyyy-MM-dd HH:mm")} UTC`),fontSize:11,stroke:"#d4d4d4",fill:"#fafafa"}))];if(e.value.valueHighlightThreshold){const t=e.value.valueHighlightThreshold;r.unshift(S(e.value.data,{x:"instant",y1:0,y2:s=>s.value===null||s.value===0?s.value===0?.005*Math.max(Math.ceil(c),e.value.yMinValue??10):c:Math.min(s.value,t.value),fill:(s,g)=>s.value===null||s.value===0?"#e5e5e5":g===e.value.data.length-1?"#ffcc80":d(t.belowVariant),rx:".1rem"})),r.unshift(S(e.value.data,{x:"instant",y1:s=>s.value===null||s.value===0?0:Math.min(s.value,t.value),y2:s=>s.value===null?c:s.value===0?.005*Math.max(Math.ceil(c),e.value.yMinValue??10):s.value>t.value?s.value:Math.min(s.value,t.value),fill:s=>s.value===null||s.value===0||s.value<=t.value?"transparent":d(t.aboveVariant),rx:".1rem"})),r.unshift(q([t.value],{stroke:"#a3a3a3",strokeWidth:2,strokeDasharray:"5,5"}))}else r.unshift(S(e.value.data,{x:"instant",y:(t,s)=>t.value!==null?t.value===0?.005*Math.max(Math.ceil(c),e.value.yMinValue??10):t.value:c,fill:(t,s)=>t.value===null||t.value===0?"#e5e5e5":s===e.value.data.length-1?"#ffcc80":"#2d90dc",rx:".1rem"}));return{marginTop:e.value.hideXAxisLabels?10:void 0,marginBottom:e.value.hideXAxisLabels?20:void 0,x:{interval:e.value.interval,label:null,tickFormat:e.value.xTickFormat,domain:e.value.xDomain??e.value.data.map(t=>t.instant instanceof D?t.instant.toMillis():t.instant)},y:{label:e.value.unit?.length!==1?e.value.unit:null,nice:!0,labelArrow:"none",labelAnchor:"center",ariaLabel:e.value.unit,domain:[0,Math.max(Math.ceil(c),e.value.yMinValue??10)],tickFormat:e.value.yTickFormat},marks:r,height:e.value.height}});return(o,c)=>e.value.data.length>0?(m(),f(j,{key:0,options:n.value},null,8,["options"])):(m(),F("div",te,"No data available."))}}),ke=[{label:"Live Update",value:"liveUpdate"},{label:"Fixed Window",value:"fixedWindow"}],V={Minutely:{label:"Per Minute",interval:"1 minute",xTickFormat:`%Y-%m-%d
%H:%M`,windowSizeSeconds:3600,maxWindowSizeSeconds:86400},Hourly:{label:"Hourly",interval:"1 hour",xTickFormat:`%Y-%m-%d
%H:%M`,windowSizeSeconds:3*86400,maxWindowSizeSeconds:30*86400},Daily:{label:"Daily",interval:"1 day",xTickFormat:i=>i,windowSizeSeconds:60*86400,maxWindowSizeSeconds:365*3*86400}};function xe(i,a){if(i)return a?.metrics?.find(l=>l.id===i)}function ie(i,a,l){if(!i)return{data:[],xTickFormat:void 0,yTickFormat:void 0};const e=Object.entries(i).map(([r,t])=>({instant:D.fromISO(r,{zone:"utc"}),value:t})),d=V[l],n=a.decimalPrecision??0,o=r=>a.unit&&a.unit.length>1?M(r)??r.toString():(a.unit&&a.unitOnFront?a.unit:"")+M(r)+(a.unit&&!a.unitOnFront?a.unit:""),c=r=>`${a.unit&&a.unitOnFront?a.unit:""}${r.value?.toFixed(n)}${a.unit&&!a.unitOnFront?a.unit:""}
${l==="Daily"?r.instant.toFormat("yyyy-MM-dd"):r.instant.toFormat("yyyy-MM-dd HH:mm")+" UTC"}`;return{data:e,interval:d.interval,xTickFormat:d.xTickFormat,yTickFormat:o,yMinValue:a.yMinValue!==0?a.yMinValue:void 0,tooltipContent:c,unit:a.unit}}function ae(i,a){if(!i?.cohorts)return{data:[],xTickFormat:void 0,yTickFormat:void 0};let l=[];if(a!==void 0){const[,o]=Object.entries(i.cohorts??{}).find(c=>Date.parse(c[0])===Date.parse(a))??["",{"":0}];Object.entries(o).some(([,c])=>c!==null)?l=Object.entries(o).filter(([,c])=>c!==null).map(([c,r])=>({instant:Number.parseInt(c,10),value:r})):l=[]}else l=Object.entries(i.weightedAverage??{}).filter(([,o])=>o!==null).map(([o,c])=>({instant:Number.parseInt(o,10),value:c}));const e=Array.from(l.map(o=>o.instant.toString())),d=o=>i.dashboardInfo?.unit&&i.dashboardInfo.unit.length>1?M(o)??o.toString():(i.dashboardInfo?.unit&&i.dashboardInfo?.unitOnFront?i.dashboardInfo.unit:"")+M(o)+(i.dashboardInfo?.unit&&!i.dashboardInfo?.unitOnFront?i.dashboardInfo?.unit:""),n=o=>`D${o.instant.toString()}: ${i.dashboardInfo?.unitOnFront?i.dashboardInfo.unit??"":""}${o.value?.toFixed(i.dashboardInfo?.decimalPrecision??0)}${i.dashboardInfo?.unit&&!i.dashboardInfo?.unitOnFront?i.dashboardInfo.unit:""}`;return{data:l,interval:1,yMinValue:i.dashboardInfo?.yMinValue!==0?i.dashboardInfo?.yMinValue:void 0,xTickFormat:o=>`D${o}`,yTickFormat:d,xDomain:e,tooltipContent:n,unit:i.dashboardInfo?.unit}}function ne(i,a){if(!i?.cohorts||!i.dashboardInfo)return{data:[],xTickFormat:void 0,yTickFormat:void 0};const e=Object.entries(i.cohorts).map(r=>{const t=Object.entries(r[1]).find(([s])=>s===a.toString())?.[1];return t!==void 0?{instant:D.fromISO(r[0],{zone:"utc"}),value:t}:void 0}).filter(r=>r!==void 0),d=i.dashboardInfo,n=d.decimalPrecision??0,o=r=>d.unit&&d.unit.length>1?M(r)??r.toString():(d.unit&&d.unitOnFront?d.unit:"")+M(r)+(d.unit&&!d.unitOnFront?d.unit:""),c=r=>`${d.unitOnFront?d.unit:""}${r.value?.toFixed(n)}${d.unitOnFront?"":d.unit}
${r.instant.toFormat("yyyy-MM-dd")}`;return{data:e,interval:V.Daily.interval,xTickFormat:V.Daily.xTickFormat,yTickFormat:o,yMinValue:d.yMinValue!==0?d.yMinValue:void 0,tooltipContent:c,unit:d.unit}}function oe(i,a){if(!i?.cohorts||!i.dashboardInfo)return{data:[],xTickFormat:void 0,yTickFormat:void 0};const l=[];let e=0;for(const[t,s]of Object.entries(i.cohorts)){let g=0;const k=D.fromISO(t,{zone:"utc"});for(const[h,b]of Object.entries(s))l.push({instant:k,value:b,cohort:h}),g+=b;e=Math.max(e,g)}const d=V[a],n=i.dashboardInfo,o=n.decimalPrecision??0,c=t=>n.unit.length>1?M(t)??t.toString():(n.unit&&n.unitOnFront?n.unit:"")+M(t)+(n.unit&&!n.unitOnFront?n.unit:""),r=t=>le(l,t,a,n,o);return{data:l,interval:d.interval,xTickFormat:d.xTickFormat,yTickFormat:c,yMinValue:Math.max(e,n.yMinValue??10),tooltipContent:r,unit:n.unit}}function re(i){return i.values?Object.entries(i.values).some(a=>a[1]!==null):i.cohorts?Object.entries(i.cohorts).some(a=>Object.entries(a[1]).some(l=>l[1]!==null)):!1}function le(i,a,l,e,d){return i.filter(o=>o.instant instanceof D).map(o=>o.instant.equals(a.instant)?`${o.cohort}: ${e.unit.length===1&&e.unitOnFront?e.unit:""}`+o.value?.toFixed(d)+`${e.unit.length===1&&!e.unitOnFront?e.unit:""}
`:"").join("")+`
`+(l==="Daily"?a.instant.toFormat("yyyy-MM-dd"):"UTC: "+a.instant.toFormat("yyyy-MM-dd HH:mm"))}function se(i,a,l,e){return{permission:"api.metrics.view",pollingPolicy:E(5e3),fetcherPolicy:U(`/metrics/single/${i}?resolution=${a}&startTime=${l.toUTC().toString()}&endTime=${e.toUTC().toString()}`),cacheRetentionPolicy:K(6e4)}}function ue(){return{permission:"api.metrics.view",pollingPolicy:E(6e4),fetcherPolicy:U("/metrics"),cacheRetentionPolicy:Y()}}const ce={key:1,class:"tw-m-[60px] tw-text-center tw-italic tw-text-neutral-500"},de=L({__name:"CohortsChart",props:{timeSeriesData:{},timeSeriesResolution:{},height:{},hideXAxisLabels:{type:Boolean}},setup(i){const a=i,l=["#2d90dc","#ebbf34","#e34a2f","#4b4cb3","#f06292","#3f6730","#7d83c9","#8702a8","#616161","#ff6d00","#00bcd4","#cddc39","#795548"],e=y(()=>oe(a.timeSeriesData,a.timeSeriesResolution)),d=y(()=>{if(a.timeSeriesData.dashboardInfo===void 0)return{};const n=e.value.data.map(c=>c.value).filter(c=>c!==null);let o=Math.max(...n);return n.length===0&&(o=e.value.yMinValue??10),{marginTop:a.hideXAxisLabels?10:void 0,marginBottom:a.hideXAxisLabels?20:void 0,x:{label:null,interval:e.value.interval,tickFormat:e.value.xTickFormat,domain:e.value.xDomain},y:{label:e.value.unit,labelArrow:"none",labelAnchor:"center",ariaLabel:e.value.unit,nice:!0,domain:[0,Math.max(Math.ceil(o),e.value.yMinValue??10)],tickFormat:e.value.yTickFormat},color:{legend:!0,range:l,n:l.length},marks:[S(e.value.data,{x:"instant",y:"value",fill:"cohort",stroke:"#fff",strokeWidth:.1,reverse:!0}),$(a.hideXAxisLabels?{ticks:[]}:{}),N(e.value.data,X({x:"instant",y:.5*o>e.value.yMinValue?.5*o:.5*e.value.yMinValue,title:e.value.tooltipContent??(c=>`${c.value}
${c.instant.toString()}`),fontSize:11,stroke:"#d4d4d4",fill:"#fafafa"}))],height:a.height}});return(n,o)=>(m(),F("div",null,[e.value.data.length>0?(m(),f(p(j),{key:0,options:d.value},null,8,["options"])):(m(),F("div",ce,"No data available."))]))}}),me={key:2,class:"tw-m-[60px] tw-text-center tw-italic tw-text-neutral-500"},ve=L({__name:"DailyCohortsChart",props:{timeSeriesData:{},cohortDate:{},selectedCohort:{},clickable:{type:Boolean},height:{},hideXAxisLabels:{type:Boolean}},emits:["cohort-selected"],setup(i,{emit:a}){const l=i,e=a,d=(r,t,s,g,k,h)=>{if(!h)throw new Error("No next render function provided");const b=h(r,t,s,g,k);if(!b)throw new Error("No element returned from next render function");const T=b.querySelectorAll("rect");for(let x=0;x<T.length;x++){if(!s.channels.x)throw new Error("No x channel found in values");const A={index:r[x],x:s.channels.x.value[x]};T[x].style.cursor="pointer",T[x].addEventListener("click",()=>{e("cohort-selected",A.x)})}return b},n=y(()=>ae(l.timeSeriesData,l.cohortDate)),o=y(()=>{if(l.selectedCohort===void 0)return;const r=ne(l.timeSeriesData,l.selectedCohort);return r.height=l.height,r.hideXAxisLabels=l.hideXAxisLabels,r}),c=y(()=>{if(l.timeSeriesData.dashboardInfo===void 0)return{};const r=n.value.data.map(s=>s.value).filter(s=>s!==null);let t=Math.max(...r);return r.length===0&&(t=n.value.yMinValue??10),{marginTop:l.hideXAxisLabels?10:void 0,marginBottom:l.hideXAxisLabels?20:void 0,x:{label:null,interval:1,tickFormat:n.value.xTickFormat,domain:n.value.xDomain},y:{label:n.value.unit?.length!==1?n.value.unit:null,labelArrow:"none",labelAnchor:"center",ariaLabel:n.value.unit,nice:!0,domain:[0,Math.max(Math.ceil(t),n.value.yMinValue??10)],tickFormat:n.value.yTickFormat},marks:[S(n.value.data,{x:"instant",y:"value",fill:"#2d90dc",rx:".1rem",render:l.clickable?d:void 0}),$(l.hideXAxisLabels?{ticks:[]}:{tickFormat:n.value.xTickFormat}),N(n.value.data,X({x:"instant",y:.5*t>n.value.yMinValue?.5*t:.5*n.value.yMinValue,title:n.value.tooltipContent??(s=>`${s.value}
${s.instant.toString()}`),stroke:"#d4d4d4",fill:"#fafafa",fontSize:11}))],height:l.height}});return(r,t)=>(m(),F("div",null,[o.value?(m(),f(p(W),{key:0,"chart-options":o.value},null,8,["chart-options"])):n.value.data.length>0?(m(),f(p(j),{key:1,options:c.value},null,8,["options"])):(m(),F("div",me,"No data available for the selected options."))]))}}),he={class:"tw-mt-2"},fe={key:0,class:"tw-mb-5 tw-text-center tw-text-neutral-500"},ye={key:1,class:"tw-overflow-hidden"},Me=L({__name:"MetricCard",props:{metricId:{},timeSeriesResolution:{},startTime:{},endTime:{},badge:{default:void 0},linkMode:{},customLink:{default:void 0},customLinkTitle:{default:void 0},compact:{type:Boolean,default:!1},cohortDate:{default:void 0},selectedCohort:{default:void 0},hideDescription:{type:Boolean,default:!1}},emits:["cohort-selected"],setup(i,{emit:a}){const l=G(),e=i,d=a,n=y(()=>{if(!r.value)return{warning:"You do not have the permission to view metrics."};if(c.value)return{error:c.value};if(!o.value)return{isLoading:!0};if(!l.doesHavePermission(t.value?.requiredPermission))return{warning:"You do not have the permission to view this metric."};if(t.value?.dailyOnly&&e.timeSeriesResolution!=="Daily")return{warning:"This metric is only available on a daily resolution."};if(g.value)return{error:g.value};if(!h.value)return{isLoading:!0};const u=k.value;return u===void 0?{error:new J("Invalid Metric ID",`The requested metric "${e.metricId}" does not exist.`)}:t.value?.hasCohorts&&(Object.values(u?.cohorts??{}).length===0||Object.values(u.cohorts??{}).every(v=>v.length===0)||Object.values(u.cohorts??{}).every(v=>Object.values(v).every(I=>I===null)))?{warning:"No data available for this metric."}:{}}),{data:o,error:c,hasPermission:r}=R(()=>ue()),t=y(()=>o.value?.metrics?.find(u=>u.id===e.metricId)?.dashboardInfo),{data:s,error:g}=R(()=>{if(!(e.timeSeriesResolution!=="Daily"&&t.value?.dailyOnly||!l.doesHavePermission(t.value?.requiredPermission)))return se(e.metricId,e.timeSeriesResolution,e.startTime,e.endTime)}),k=Q();z([s],([u],[v])=>{u&&(k.value=u)},{immediate:!0}),z([()=>e.metricId,()=>e.timeSeriesResolution==="Daily"],()=>{k.value=void 0});const h=y(()=>k.value);function b(){return`metrics/${e.metricId}?resolution=${e.timeSeriesResolution}&preset=custom&start=${e.startTime.toISO()}&end=${e.endTime.toISO()}`}function T(){const u=Math.round(e.endTime.diff(e.startTime).as("minutes"));return`metrics/${e.metricId}?resolution=${e.timeSeriesResolution}&preset=custom&timeWindowMode=liveUpdate&duration=PT${u}M`}function x(){switch(e.linkMode){case"detail-view":return`/metrics/${e.metricId}`;case"live-updating-link-to-metric":return T()??"";case"time-range-link-to-metric":return b()??"";case"custom-link":return e.customLink??"";case"none":throw new Error('Requested link when linkMode is "none"')}}const A=y(()=>{if(!h.value||!t.value)return{data:[]};const u=ie(h.value.values,t.value,e.timeSeriesResolution);return u.hideXAxisLabels=e.compact||u.hideXAxisLabels,u.height=e.compact?200:void 0,u.unit=t.value.unit,u});return(u,v)=>(m(),f(p(Z),{title:t.value?.name??h.value?.id??"Metric Chart",variant:n.value.warning?"neutral":"primary","is-loading":n.value.isLoading,error:n.value.error,badge:u.badge,"no-body-padding":!!u.compact,"data-testid":`metrics-card-${u.metricId}`},ee({"header-right":w(()=>[u.linkMode==="detail-view"?(m(),f(p(O),{key:0,"disabled-tooltip":n.value.warning?"No details available for this metric.":void 0,to:x()},{default:w(()=>v[1]||(v[1]=[C("View metric",-1)]),void 0,!0),_:1,__:[1]},8,["disabled-tooltip","to"])):u.linkMode==="live-updating-link-to-metric"?(m(),f(p(O),{key:1,"disabled-tooltip":n.value.warning?"No details available for this metric.":void 0,to:T()},{default:w(()=>v[2]||(v[2]=[C("View metric",-1)]),void 0,!0),_:1,__:[2]},8,["disabled-tooltip","to"])):u.linkMode==="time-range-link-to-metric"?(m(),f(p(O),{key:2,"disabled-tooltip":n.value.warning?"No details available for this metric.":void 0,to:b()},{default:w(()=>v[3]||(v[3]=[C("View metric",-1)]),void 0,!0),_:1,__:[3]},8,["disabled-tooltip","to"])):u.linkMode==="custom-link"?(m(),f(p(O),{key:3,"disabled-tooltip":n.value.warning?"No details available for this metric.":void 0,to:u.customLink},{default:w(()=>[C(P(u.customLinkTitle),1)],void 0,!0),_:1},8,["disabled-tooltip","to"])):H("",!0)]),default:w(()=>[n.value.warning?(m(),F("div",fe,P(n.value.warning),1)):t.value&&h.value&&p(re)(h.value)?(m(),F("div",ye,[v[4]||(v[4]=B("div",{class:"tw-h-full tw-overflow-y-auto"},null,-1)),t.value.hasCohorts?t.value.isDailyCohorts?(m(),f(ve,{key:1,"time-series-data":h.value,class:_({"tw-px-3":u.compact}),height:u.compact?200:void 0,"hide-x-axis-labels":u.compact||void 0,"selected-cohort":u.selectedCohort,"cohort-date":u.cohortDate,clickable:!0,onCohortSelected:v[0]||(v[0]=I=>d("cohort-selected",I))},null,8,["time-series-data","class","height","hide-x-axis-labels","selected-cohort","cohort-date"])):t.value.hasCohorts?(m(),f(de,{key:2,"time-series-data":h.value,"time-series-resolution":u.timeSeriesResolution,class:_({"tw-px-3":u.compact}),height:u.compact?200:void 0,"hide-x-axis-labels":u.compact||void 0},null,8,["time-series-data","time-series-resolution","class","height","hide-x-axis-labels"])):H("",!0):(m(),f(p(W),{key:0,"chart-options":A.value,class:_({"tw-px-3":u.compact}),height:u.compact?200:void 0,"hide-x-axis-labels":u.compact||void 0},null,8,["chart-options","class","height","hide-x-axis-labels"]))])):H("",!0)],void 0,!0),_:2},[!u.compact&&!u.hideDescription?{name:"subtitle",fn:w(()=>[B("p",he,P(t.value?.purposeDescription??"No description available"),1)]),key:"0"}:void 0]),1032,["title","variant","is-loading","error","badge","no-body-padding","data-testid"]))}});export{Me as _,xe as a,se as b,ue as g,V as r,ke as t};
