import{d as M,C as N,c as L,a as d,o as u,F as H,b as B,e as g,w as s,k as n,t as i,f as a,_,a7 as X,q as y,ab as Z,E as ee,h as R,K as te,r as O,m as k,j as o,s as se,v as re,x as p,y as $,D,Q as ae,bm as ne,U as oe,bs as ue,bt as ie}from"./index-DAyiym1a.js";import de from"./MetaListCard-CjpVaEvN.js";import{M as S,a as P,b as F,c as h}from"./metaListUtils-B-xQ0HnD.js";import{a as le}from"./players-CkgXyjra.js";import{a as ce}from"./rewardUtils-C0-L1SL8.js";import{_ as pe}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CRnsCPt_.js";import"./utils-DSYdgMhH.js";import"./_baseIteratee-CfhjPvCd.js";import"./isSymbol-BXvDeGRF.js";import"./identity-DKeuBCMA.js";import"./MInputText.vue_vue_type_script_setup_true_lang-B9sf9LSD.js";import"./MInputHintMessage.vue_vue_type_script_setup_true_lang-B7AbTbVm.js";import"./debounce-CRuraxcR.js";import"./MInputMultiSelectCheckbox.vue_vue_type_script_setup_true_lang-D6xsoOzq.js";import"./MInputCheckbox.vue_vue_type_script_setup_true_lang-CmGaUCkv.js";import"./MInputSingleSelectRadio.vue_vue_type_script_setup_true_lang-CGM7lb3s.js";import"./index-TQG-La0y.js";import"./button-group-DBs956_t.js";import"./MActionModal.vue_vue_type_script_setup_true_lang-XDUxofmt.js";import"./index-CVSO09yM.js";const fe={key:0},me={key:1},he={class:"text-danger"},ye=M({__name:"OfferSpan",props:{offer:{type:Object,required:!0}},setup(v){const m=v,x=N(),b=L(()=>m.offer.$type==="Metaplay.Core.InAppPurchase.ResolvedPurchaseMetaRewards"?m.offer.rewards.map(f=>ce(f).getDisplayValue(f)):x.gameSpecific.iapContents.find(f=>f.$type===m.offer.$type)?.getDisplayContent(m.offer)??null);return(f,T)=>b.value?(u(),d("span",fe,[(u(!0),d(H,null,B(b.value,l=>(u(),g(a(_),{class:"tw-ml-1",key:l},{default:s(()=>[n(i(l),1)],void 0,!0),_:2},1024))),128))])):(u(),d("span",me,[X(f.$slots,"default",{},()=>[y("span",he,"Error: undefined offer type '"+i(v.offer.$type)+"'",1)])]))}}),ge={key:0},_e={class:"tw-mr-1"},ve={key:0,class:"tw-text-neutral-500"},be={key:1},we={class:"text-muted"},Se={key:0,class:"text-muted"},Pe={key:1},xe={key:0,class:"text-muted"},Ce={key:1},Ie={key:2},Re={key:0,class:"text-muted"},ke={key:1},$e={key:0},De={key:1},Je=M({__name:"PlayerPurchaseHistoryCard",props:{playerId:{}},setup(v){const m=v,x=ue(),b=ie(),f=N(),T=Z(),{data:l,refresh:U}=ee(le(m.playerId)),C=R();function q(t){return`${t.purchase.transactionId}-${t.purchase.purchaseTime}`}te(l,j,{immediate:!0});function j(){const t=[];if(l.value){Object.keys(l.value.model.pendingInAppPurchases).forEach(c=>{t.push({isPending:!0,purchase:l.value.model.pendingInAppPurchases[c]})});const e=T.featureFlags.iapPlatformRefundSupport;for(const c of l.value.model.inAppPurchaseHistory)t.push({platformRefundSupport:e[c.platform]??"NotSupported",purchase:c});for(const c of l.value.model.duplicateInAppPurchaseHistory)t.push({isDuplicate:!0,purchase:c});for(const c of l.value.model.failedInAppPurchaseHistory)t.push({purchase:c})}C.value=t}const E=["purchase.platform","purchase.productId","purchase.transactionId","purchase.alternativePurchaseId"],G=[new S("Purchase time","purchase.purchaseTime",P.Ascending),new S("Purchase time","purchase.purchaseTime",P.Descending),new S("Price","purchase.referencePrice",P.Ascending),new S("Price","purchase.referencePrice",P.Descending)],z=R(1),K=L(()=>[F.asDynamicFilterSet(C.value,"product-id",t=>t.purchase.productId),new F("status",[new h("Successful",t=>t.purchase.status==="Successful"),new h("Failed",t=>t.purchase.status==="Failed"),new h("Pending validation",t=>t.purchase.status==="PendingValidation"),new h("Refunded",t=>t.purchase.status==="Refunded"),new h("Receipt already used",t=>t.purchase.status==="ReceiptAlreadyUsed"),new h("Other",t=>!["Successful","PendingValidation","Refunded","ReceiptAlreadyUsed","Failed"].includes(t.purchase.status))])]),I=R();async function Q(){await x.post(`/players/${l.value.id}/refund/${I.value.purchase.transactionId}`),b.showSuccessNotification("Refunded successfully."),U()}function w(t){const e={PendingValidation:{text:"Pending validation",statusClass:"text-warning",badgeVariant:"neutral"},Successful:{text:"Successful",statusClass:"text-success",badgeVariant:"success"},Failed:{text:"Failed",statusClass:"text-danger",badgeVariant:"danger"},ReceiptAlreadyUsed:{text:"Receipt already used",statusClass:"text-warning",badgeVariant:"neutral"},Refunded:{text:"Refunded",statusClass:"text-warning",badgeVariant:"neutral"},UserDeclined:{text:"Declined by user",statusClass:"text-warning",badgeVariant:"neutral"},Abandoned:{text:"Purchase interrupted",statusClass:"text-warning",badgeVariant:"neutral"}};return t.purchase.status in e?e[t.purchase.status]:{text:t.purchase.status,statusClass:"text-warning",badgeVariant:"neutral"}}function A(t){const e=f.gameSpecific.iapContents.find(c=>c.$type===t.purchase.dynamicContent.$type);return e?e.getDisplayContent(t.purchase.dynamicContent).join(", "):null}function W(t){if(t.purchase.status==="Refunded")return"This purchase has already been refunded.";if(t.purchase.status==="PendingValidation")return"The purchase hasn't yet been completed.";if(t.purchase.status!=="Successful")return"Only successful purchases can be refunded.";if(t.isPending)return"The client must claim the purchase before it can be refunded.";if(t.platformRefundSupport==="NotSupported")return`Refunding is not supported on the ${t.purchase.platform} platform.`;if(t.platformRefundSupport==="NotConfigured")return`${t.purchase.platform} refunds have not been configured.`}return(t,e)=>{const c=O("meta-reward-badge"),Y=O("meta-no-seatbelts");return a(l)?(u(),d("div",ge,[o(a(de),{class:"tw-mb-4",title:"Purchase History",icon:"money-check-alt",itemList:C.value,getItemKey:q,searchFields:E,sortOptions:G,defaultSortOption:z.value,filterSets:K.value,emptyMessage:"No purchases... yet!","data-testid":"player-purchase-history-card"},{"item-card":s(({item:r})=>[o(a(se),{extraMListItemMargin:""},{header:s(()=>[o(a(p),{noLeftPadding:""},{badge:s(()=>[r.isPending?(u(),g(a(_),{key:0,variant:"warning"},{default:s(()=>e[2]||(e[2]=[n("Pending",-1)]),void 0,!0),_:1,__:[2]})):r.isDuplicate?(u(),g(a(_),{key:1},{default:s(()=>e[3]||(e[3]=[n("Duplicate",-1)]),void 0,!0),_:1,__:[3]})):(u(),g(a(_),{key:2,variant:w(r).badgeVariant},{default:s(()=>[n(i(w(r).text),1)],void 0,!0),_:2},1032,["variant"]))]),"top-right":s(()=>[o(a($),{instant:a(D).fromISO(r.purchase.purchaseTime),showAs:"dateTime"},null,8,["instant"])]),"bottom-left":s(()=>[n(i(r.purchase.transactionId),1)]),"bottom-right":s(()=>[n(i(r.purchase.platform),1)]),default:s(()=>[y("span",_e,i(r.purchase.productId),1),r.purchase.subscriptionQueryResult===null?(u(),d("span",ve,"($"+i(r.purchase.referencePrice.toFixed(2))+")",1)):(u(),d("span",be,[e[0]||(e[0]=n("(",-1)),o(a(oe),{content:"Subscription purchases are not applied directly towards the player's total spend. Please see Subscription History instead."},{default:s(()=>[n("$"+i(r.purchase.referencePrice.toFixed(2)),1)],void 0,!0),_:2},1024),e[1]||(e[1]=n(")",-1))]))],void 0,!0),_:2},1024)]),default:s(()=>[o(a(re),{showBorder:"",striped:""},{default:s(()=>[o(a(p),{condensed:""},{"top-right":s(()=>[n(i(r.purchase.platform),1)]),default:s(()=>[e[4]||(e[4]=n("Platform",-1))],void 0,!0),_:2,__:[4]},1024),o(a(p),{condensed:""},{"top-right":s(()=>[y("span",we,i(r.purchase.transactionId),1)]),default:s(()=>[e[5]||(e[5]=n("Transaction ID",-1))],void 0,!0),_:2,__:[5]},1024),o(a(p),{condensed:""},{"top-right":s(()=>[r.purchase.alternativePurchaseId===null?(u(),d("span",Se,"None")):(u(),d("span",Pe,i(r.purchase.alternativePurchaseId),1))]),default:s(()=>[e[6]||(e[6]=n("Alternative Purchase ID",-1))],void 0,!0),_:2,__:[6]},1024),o(a(p),{condensed:""},{"top-right":s(()=>[n(i(r.purchase.productId),1)]),default:s(()=>[e[7]||(e[7]=n("Product ID",-1))],void 0,!0),_:2,__:[7]},1024),o(a(p),{condensed:""},{"top-right":s(()=>[n(i(r.purchase.platformProductId),1)]),default:s(()=>[e[8]||(e[8]=n("Platform Product ID",-1))],void 0,!0),_:2,__:[8]},1024),o(a(p),{condensed:""},{"top-right":s(()=>[n("$"+i(r.purchase.referencePrice.toFixed(2)),1)]),default:s(()=>[e[9]||(e[9]=n("Reference Price",-1))],void 0,!0),_:2,__:[9]},1024),o(a(p),{condensed:""},{"top-right":s(()=>[r.purchase.dynamicContent?A(r)?(u(),d("span",Ce,i(A(r)),1)):(u(),d("span",Ie,"Unknown "+i(r.purchase.dynamicContent.$type),1)):(u(),d("span",xe,"None"))]),default:s(()=>[e[10]||(e[10]=n("Related Offer",-1))],void 0,!0),_:2,__:[10]},1024),o(a(p),{condensed:""},{"top-right":s(()=>[!r.purchase.resolvedContent&&!r.purchase.resolvedDynamicContent?(u(),d("span",Re,"None")):(u(),d("span",ke,[r.purchase.resolvedContent?(u(),d("span",$e,[o(ye,{offer:r.purchase.resolvedContent},null,8,["offer"])])):k("",!0),r.purchase.resolvedDynamicContent?(u(),d("span",De,[(u(!0),d(H,null,B(r.purchase.resolvedDynamicContent.rewards,(V,J)=>(u(),g(c,{key:J,reward:V},null,8,["reward"]))),128))])):k("",!0)]))]),default:s(()=>[e[11]||(e[11]=n("Content",-1))],void 0,!0),_:2,__:[11]},1024),o(a(p),{condensed:""},{"top-right":s(()=>[o(a($),{instant:a(D).fromISO(r.purchase.purchaseTime),showAs:"dateTime"},null,8,["instant"])]),default:s(()=>[e[12]||(e[12]=n("Purchase Time",-1))],void 0,!0),_:2,__:[12]},1024),o(a(p),{condensed:""},{"top-right":s(()=>[o(a($),{instant:a(D).fromISO(r.purchase.claimTime),showAs:"dateTime"},null,8,["instant"])]),default:s(()=>[e[13]||(e[13]=n("Claim Time",-1))],void 0,!0),_:2,__:[13]},1024),o(a(p),{condensed:""},{"top-right":s(()=>[y("div",{class:ae(["text-right text-break-word",w(r).statusClass])},i(w(r).text),3)]),default:s(()=>[e[14]||(e[14]=n("Status",-1))],void 0,!0),_:2,__:[14]},1024)],void 0,!0),_:2},1024),o(a(ne),{class:"tw-mt-2"},{default:s(()=>[o(a(pe),{"trigger-button-disabled-tooltip":W(r),"modal-title":"Refund In-App-Purchase",action:Q,"trigger-button-label":"Issue Refund","trigger-button-size":"small",variant:"danger","ok-button-label":"Refund",permission:"api.players.iap_refund",onShow:V=>I.value=r},{default:s(()=>[y("p",null,[e[15]||(e[15]=n("You can issue a refund for the purchase ",-1)),o(a(_),null,{default:s(()=>[n(i(I.value?.purchase.transactionId),1)],void 0,!0),_:1}),n(". The game server will request the "+i(r.purchase.platform)+" store to refund the player. The in-game items will be revoked from the player if revocation has been implemented in this game.",1)]),e[16]||(e[16]=y("span",{class:"tw-text-xs+ tw-text-neutral-500"},"Note: On some platforms, refunds requested by the player directly from the store are not available to display here. Requesting a refund multiple times from here will not issue the refund more than once.",-1)),o(Y,{class:"tw-mt-4"})],void 0,!0),_:2,__:[16]},1032,["trigger-button-disabled-tooltip","onShow"])],void 0,!0),_:2},1024)],void 0,!0),_:2},1024)]),_:1},8,["itemList","defaultSortOption","filterSets"])])):k("",!0)}}});export{Je as default};
