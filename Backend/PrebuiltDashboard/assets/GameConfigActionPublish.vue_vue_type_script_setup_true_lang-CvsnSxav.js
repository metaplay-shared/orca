import{d as R,cj as E,h,c as f,E as P,K as U,c9 as F,cc as G,r as W,a as p,o as n,e as S,j as l,f as o,ae as $,w as a,k as s,T as j,q as i,a6 as z,m as q,_ as K,t as C,ad as B,F as L,c6 as H,bs as J,bt as Q}from"./index-DAyiym1a.js";import{_ as X}from"./MInputSingleSelectRadio.vue_vue_type_script_setup_true_lang-CGM7lb3s.js";import{_ as Y}from"./MInputCheckbox.vue_vue_type_script_setup_true_lang-CmGaUCkv.js";import{_ as Z}from"./MActionModal.vue_vue_type_script_setup_true_lang-XDUxofmt.js";const ee={key:0,class:"my-5 tw-w-full tw-text-center"},te={key:1},ie={class:"tw-ml-1"},oe={key:2},ae={class:"tw-mt-3 tw-rounded-lg tw-border tw-border-neutral-200 tw-bg-neutral-50 tw-p-3"},se={class:"tw-font-semibold"},ne={key:0,class:"tw-mt-3"},le={class:"tw-font-semibold"},ve=R({__name:"GameConfigActionPublish",props:{gameConfigId:{},textButton:{type:Boolean},publishBlocked:{type:Boolean}},setup(I){const y=J(),k=E(),u=I,c=h(),r=f(()=>{const t=v.value?.find(e=>e.id===u.gameConfigId);return t?(v.value??[]).filter(e=>!e.isArchived&&!(e.publishedAt!==null||e.unpublishedAt!==null||e.isActive)&&e.buildStartedAt<t.buildStartedAt).map(e=>e.id):[]}),m=h(!1),b=h(!1),N=[{label:"Gradual Rollout",value:!1,hintMessage:"Currently live players will continue using the config they started with for their current play session."},{label:"Forced Rollout",value:!0,hintMessage:"This will immediately disconnect all live players and force them to download the new config. This is useful for critical updates."}];U(()=>m.value,t=>{k.toggleAutoArchiveWhenPublishing(t)});const O=f(()=>w.value?.name||"No Name Available"),{data:v,refresh:ue}=P(F()),{data:T,error:re,refresh:de}=P(G(u.gameConfigId)),w=f(()=>{if(v.value)return v.value.find(t=>t.id===u.gameConfigId)}),_=f(()=>w.value?.isActive?"This game config is already active.":T.value?.status==="Building"?"Cannot publish a game config while it's being built":w.value?.publishBlockingErrors.length??u.publishBlocked?"Cannot publish a game config that contains errors.":void 0),d=h();function V(){d.value=void 0,setTimeout(()=>{H(G(u.gameConfigId)).then(t=>{d.value=t.publishBlockingErrors.length>0})},1e3),m.value=k.autoArchiveWhenPublishing}const D=f(()=>d.value===!0?"Cannot publish a game config that contains errors.":d.value===void 0?"Validating that game config can be published.":void 0),{showSuccessNotification:A}=Q();async function x(){await y.post(`/gameConfig/publish?parentMustMatchActive=false&kickConnectedClients=${b.value}`,{Id:u.gameConfigId}),A("Game config published."),m.value&&r.value.length>0&&(await y.post("/gameConfig/archive",r.value),A(`Archived ${r.value.length} game configs.`)),window.location.reload()}return(t,e)=>{const M=W("b-spinner");return n(),p(L,null,[t.textButton?(n(),S(o($),{key:0,"disabled-tooltip":_.value,"confirm-permission":"api.game_config.edit",onClick:c.value?.open,"data-testid":`publish-game-config-text-button-${t.gameConfigId}`},{default:a(()=>e[3]||(e[3]=[s("Publish",-1)]),void 0,!0),_:1,__:[3]},8,["disabled-tooltip","onClick","data-testid"])):(n(),S(o(j),{key:1,"disabled-tooltip":_.value,"confirm-permission":"api.game_config.edit","full-width":"",onClick:e[0]||(e[0]=g=>c.value?.open()),"data-testid":`publish-game-config-button-${t.gameConfigId}`},{default:a(()=>e[4]||(e[4]=[s("Publish",-1)]),void 0,!0),_:1,__:[4]},8,["disabled-tooltip","data-testid"])),l(o(Z),{ref_key:"gameConfigPublishModal",ref:c,title:"Publish Game Config",action:x,"ok-button-label":"Publish Config","ok-button-disabled-tooltip":D.value,"confirm-permission":"api.game_config.edit",onShow:V,"data-testid":`publish-game-config-modal-${t.gameConfigId}`},{default:a(()=>[d.value===void 0?(n(),p("div",ee,[e[5]||(e[5]=i("div",{class:"font-weight-bold"},"Validating Game Config",-1)),e[6]||(e[6]=i("div",{class:"small text-muted tw-mt-1"},"Please wait while we check that this config is valid for publishing.",-1)),l(M,{class:"tw-mt-3",label:"Validating..."})])):d.value?(n(),p("div",te,[l(o(z),{title:"Cannot Publish Game Config",variant:"danger"},{default:a(()=>[e[10]||(e[10]=i("span",null,"This config cannot be validated for publishing because it contains errors.",-1)),i("span",ie,[e[8]||(e[8]=s("Please view the ",-1)),l(o($),{to:`/gameConfigs/${t.gameConfigId}`},{default:a(()=>e[7]||(e[7]=[s("config's details page",-1)]),void 0,!0),_:1,__:[7]},8,["to"]),e[9]||(e[9]=s(" to see the errors.",-1))])],void 0,!0),_:1,__:[10]})])):(n(),p("div",oe,[i("p",null,[e[11]||(e[11]=s("Publishing ",-1)),l(o(K),{variant:"neutral"},{default:a(()=>[s(C(O.value),1)],void 0,!0),_:1}),e[12]||(e[12]=s(" will make it the active game config, effective immediately.",-1))]),e[15]||(e[15]=i("p",{class:"tw-text-xs+ tw-text-neutral-500"},"Other people using the LiveOps Dashboard at the moment may be disrupted by the game data changing while they work, so make sure to let them know you are publishing an update!",-1)),i("div",ae,[e[13]||(e[13]=i("p",{class:"tw-font-semibold"},"Game Config Rollout",-1)),e[14]||(e[14]=i("p",{class:"tw-my-2 tw-text-xs+ tw-text-neutral-500"},"Players will download the new config the next time they login. Choose how you want to rollout the new config.",-1)),l(o(X),{"model-value":b.value,options:N,size:"small","onUpdate:modelValue":e[1]||(e[1]=g=>b.value=g)},{option:a(({option:g})=>[i("span",se,C(g.label),1)]),_:1},8,["model-value"])]),r.value?.length>0?(n(),p("div",ne,[l(o(Y),{"model-value":m.value,size:"small","hint-message":`At the same time as publishing this game config, you can also archive ${o(B)(r.value?.length,"older, unpublished config",!0)}. This is useful in keeping your game config history manageable.`,"onUpdate:modelValue":e[2]||(e[2]=g=>m.value=g)},{default:a(()=>[i("span",le,"Also Archive "+C(o(B)(r.value?.length,"Older, Unpublished Config",!0)),1)],void 0,!0),_:1},8,["model-value","hint-message"])])):q("",!0),e[16]||(e[16]=i("p",{class:"tw-mt-3"},"All good?",-1))]))],void 0,!0),_:1},8,["ok-button-disabled-tooltip","data-testid"])],64)}}});export{ve as _};
