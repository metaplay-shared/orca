import{bo as O,bp as _,bq as k,br as R,d as q,h as C,D as g,c as d,ab as j,r as z,e as F,o as A,f as n,I as G,w as c,ag as K,q as l,j as s,m as Z,bs as H,bt as J}from"./index-DAyiym1a.js";import{_ as Q}from"./MetaGeneratedForm.vue_vue_type_script_setup_true_lang-DdaVgxEJ.js";import{_ as V}from"./PlayerSegmentsInput.vue_vue_type_script_setup_true_lang-D-tzace6.js";import{_ as W}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CRnsCPt_.js";import{_ as X}from"./MInputSwitch.vue_vue_type_script_setup_true_lang-BI0IeYnL.js";import{_ as Y}from"./MInputNumber.vue_vue_type_script_setup_true_lang-qrqxgTEu.js";import{_ as I}from"./MInputText.vue_vue_type_script_setup_true_lang-B9sf9LSD.js";import{_ as ee}from"./MInputDateTime.vue_vue_type_script_setup_true_lang-BaxH1mqp.js";function me(){return{permission:"api.notifications.view",pollingPolicy:k(5e3),fetcherPolicy:_("/notifications"),cacheRetentionPolicy:O()}}function fe(f){return{permission:"api.notifications.view",pollingPolicy:k(5e3),fetcherPolicy:_(`/notifications/${f}`),cacheRetentionPolicy:R(1e4)}}const te={class:"tw-inline-flex tw-w-full tw-gap-x-4"},ae={class:"tw-@container"},ie={class:"tw-mt-4 tw-rounded tw-border tw-border-neutral-200 tw-bg-neutral-100 tw-p-3"},m=50,pe=q({__name:"NotificationFormButton",props:{modalTitle:{},buttonText:{},oldNotification:{},update:{type:Boolean},buttonIcon:{}},emits:["refresh"],setup(f,{emit:T}){const o=f,v=H(),{isDeveloperUiEnabled:S}=K(),e=C(y());function y(){return{name:"",targetTime:g.utc(),content:{title:void 0,body:void 0},debugEntityIdValueUpperBound:100,debugFakeNotificationMode:!1,firebaseAnalyticsLabel:"",audience:V.props.modelValue.default()}}function L(t){e.value.name=t,P()}const p=d(()=>!(!e.value.name||e.value.name.length===0));function P(){e.value.firebaseAnalyticsLabel=U(e.value.name)}const w=["-","_",".","~","%"];function U(t){let a="";for(let r=0;r<t.length;r++){const i=t.charAt(r);N(i)?a+=i:i===" "?a+="_":a+="%"}return a.length>m&&(a=a.substring(0,m)),a}function N(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t>="0"&&t<="9"||w.includes(t)}const b=d(()=>{const t=e.value.firebaseAnalyticsLabel;if(t.length>m)return!1;for(let a=0;a<t.length;a++)if(!N(t.charAt(a)))return!1;return t?!0:null}),u=C(!1),B=d(()=>{if(!p.value&&!u.value)return"Fill in the required fields to proceed.";if(!p.value)return"Fill in a valid name to proceed.";if(!u.value)return"Fill in the notification message in all selected locales to proceed.";if(!e.value.audience.valid)return"The audience targeting is invalid. Check that it is filled out correctly to proceed.";if(!b.value)return"The Firebase analytics label is invalid. Check that it is set correctly to proceed."});function E(t){t&&(e.value.targetTime=t)}const D=T,{showSuccessNotification:h}=J();async function M(){const t={name:e.value.name,targetTime:e.value.targetTime.toISO(),content:e.value.content,firebaseAnalyticsLabel:e.value.firebaseAnalyticsLabel,targetPlayers:e.value.audience.targetPlayers,targetCondition:e.value.audience.targetCondition};if(e.value.debugFakeNotificationMode&&(t.debugFakeNotificationMode=!0,t.debugEntityIdValueUpperBound=e.value.debugEntityIdValueUpperBound),o.update){if(t.id=o.oldNotification?.id,!t.id)throw new Error("Cannot update campaign without ID.");await v.put(`/notifications/${t.id}`,t),h("Campaign updated.")}else await v.post("/notifications",t),h("New push notification campaign created.");D("refresh")}function $(){o.oldNotification?(e.value.name=o.update?o.oldNotification.name:o.oldNotification.name+" (copy)",e.value.targetTime=o.update?g.fromISO(o.oldNotification.targetTime):g.utc(),e.value.content=o.oldNotification.content,e.value.debugFakeNotificationMode=o.oldNotification.debugFakeNotificationMode??!1,e.value.debugEntityIdValueUpperBound=o.oldNotification.debugEntityIdValueUpperBound??100,e.value.firebaseAnalyticsLabel=o.oldNotification.firebaseAnalyticsLabel,e.value.audience.targetPlayers=o.oldNotification.targetPlayers,e.value.audience.targetCondition=o.oldNotification.targetCondition,u.value=!0):e.value=y()}const x=d(()=>j().featureFlags.pushNotifications);return(t,a)=>{const r=z("fa-icon");return A(),F(n(W),{"modal-title":t.modalTitle,action:M,"trigger-button-label":t.buttonText,"trigger-button-disabled-tooltip":x.value?void 0:"Push notifications are not enabled for this deployment.","ok-button-label":"Start Campaign","ok-button-disabled-tooltip":B.value,permission:"api.notifications.edit",onShow:$},G({"trigger-button-icon":c(()=>[t.buttonIcon?(A(),F(r,{key:0,class:"tw-mb-[0.05rem] tw-h-3.5 tw-w-4 tw-space-x-2",icon:t.buttonIcon},null,8,["icon"])):Z("",!0)]),"right-panel":c(()=>[l("div",ae,[s(Q,{class:"tw-mt-3",typeName:"Metaplay.Server.NotificationCampaign.NotificationContent",value:e.value.content,page:"NotificationFormButton","is-targeting-multiple-players":"",onInput:a[2]||(a[2]=i=>e.value.content=i),onStatus:a[3]||(a[3]=i=>u.value=i)},null,8,["value"])])]),default:c(()=>[l("div",te,[s(n(I),{class:"tw-grow",label:"Campaign Name","model-value":e.value.name,variant:p.value?"success":"danger",placeholder:"Campaign name here...","onUpdate:modelValue":L},null,8,["model-value","variant"]),s(n(ee),{class:"tw-grow","model-value":e.value.targetTime,"min-date-time":"utcNow",label:"Date","onUpdate:modelValue":E},null,8,["model-value"])]),s(n(I),{class:"tw-mt-3",label:"Firebase Analytics Label","model-value":e.value.firebaseAnalyticsLabel,variant:b.value!==null?b.value?"success":"danger":"default",placeholder:"Optional analytics label...","hint-message":`At most ${m} characters; ASCII alphanumerics and ${w.join(" ")}`,"onUpdate:modelValue":a[0]||(a[0]=i=>e.value.firebaseAnalyticsLabel=i)},null,8,["model-value","variant","hint-message"]),s(V,{class:"tw-mt-3","model-value":e.value.audience,"onUpdate:modelValue":a[1]||(a[1]=i=>e.value.audience=i)},null,8,["model-value"])],void 0,!0),_:2},[n(S)?{name:"bottom-panel",fn:c(()=>[l("div",ie,[a[6]||(a[6]=l("span",{class:"tw-mr-1 tw-font-semibold"},"Debug Options",-1)),a[7]||(a[7]=l("span",{class:"tw-space-x-1 tw-text-xs+ tw-normal-case tw-text-neutral-500"},[l("span",null,"Visible in developer mode."),l("span",{class:"tw-text-red-500"},"Do not use these in production!")],-1)),s(n(X),{class:"tw-mt-2","model-value":e.value.debugFakeNotificationMode,label:"Fake notification mode",name:"fakeNotificationModeEnabled",size:"small","onUpdate:modelValue":a[4]||(a[4]=i=>e.value.debugFakeNotificationMode=i)},null,8,["model-value"]),s(n(Y),{label:"Debug Entity ID Bound","model-value":e.value.debugEntityIdValueUpperBound,disabled:!e.value.debugFakeNotificationMode,min:1,"hint-message":"Set this to the number of bots you are running for best results.","onUpdate:modelValue":a[5]||(a[5]=i=>e.value.debugEntityIdValueUpperBound=i)},null,8,["model-value","disabled"])])]),key:"0"}:void 0]),1032,["modal-title","trigger-button-label","trigger-button-disabled-tooltip","ok-button-disabled-tooltip"])}}});export{pe as _,fe as a,me as g};
