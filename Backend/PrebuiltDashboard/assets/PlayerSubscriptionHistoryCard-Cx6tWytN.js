import{d as z,C as J,ab as W,E as X,h as Z,c as $,ad as N,r as R,a as l,m as w,f as e,o as n,j as a,w as s,s as tt,q as h,v as K,x as g,k as o,y,D as p,e as S,_,t as d,F as L,b as C,U as et,ae as st,bs as it,bt as nt}from"./index-DAyiym1a.js";import{M as T,a as k}from"./metaListUtils-B-xQ0HnD.js";import{a as ot}from"./players-CkgXyjra.js";import{_ as at}from"./MActionModalButton.vue_vue_type_script_setup_true_lang-CRnsCPt_.js";import"./MActionModal.vue_vue_type_script_setup_true_lang-XDUxofmt.js";import"./index-CVSO09yM.js";const rt={key:0},lt={class:"tw-ml-1 tw-text-neutral-500"},dt={key:0,class:"tw-text-red-500"},ut={key:0},pt={key:0},mt={key:1},ct={key:2,class:"tw-text-orange-400"},ft={key:1},vt={key:2},wt={key:0,class:"font-weight-bold tw-mb-1"},yt={key:0,class:"text-danger"},St={key:0,class:"tw-text-right"},_t={key:1,class:"tw-text-right"},bt={key:2,class:"tw-text-right"},ht={class:"tw-mt-1 tw-inline-flex tw-w-full tw-justify-end"},Pt=z({__name:"PlayerSubscriptionHistoryCard",props:{playerId:{}},setup(F){const M=F,B=it();J();const j=W(),{data:u,refresh:V}=X(ot(M.playerId)),q=[new T("Start time","startTime",k.Ascending),new T("Start time","startTime",k.Descending),new T("Expiry time","expirationTime",k.Ascending),new T("Expiry time","expirationTime",k.Descending)],E=Z({}),H=$(()=>j.featureFlags.removeIapSubscriptions||u.value.model.isDeveloper),U=$(()=>{const c={};for(const m of u.value.model.inAppPurchaseHistory){if(m.subscriptionQueryResult===null)continue;const f=m.originalTransactionId;c[f]=m}const t=[];for(const m in u.value.model.iapSubscriptions.subscriptions){if(!Object.hasOwn(u.value.model.iapSubscriptions.subscriptions,m))continue;const f=u.value.model.iapSubscriptions.subscriptions[m];let i=0;const r={};for(const v in f.subscriptionInstances){if(!Object.hasOwn(f.subscriptionInstances,v))continue;const b=f.subscriptionInstances[v],A=c[v],Y=A?.platform,P=A?.referencePrice??0;let x,I;if(b.disabledDueToReuse)x=0,I="Spend is omitted from this subscription, because it is being used on another player account.";else if(b.lastKnownState?.isAcquiredViaFamilySharing??!1)x=0,I="Spend is omitted from this subscription, because this player acquired it via Family Sharing instead of purchasing it themselves.";else{const D=b.lastKnownState?.numPeriods??1;x=D*P,I=`${N(D,"period",!0)}, reference price ${P}`}i+=x,r[v]={platform:Y,spend:x,spendExplanation:I,referencePrice:P,otherPlayers:u.value.iapSubscriptionsExtra.instances[v].otherPlayers,...b}}t.unshift({productId:m,spend:i,...f,subscriptionInstances:r})}return t}),{showSuccessNotification:G}=nt();async function Q(c){await B.post(`/players/${u.value.model.playerId}/removeIAPSubscription/${c}`),G(`Subscription '${c}' detached from this player.`),V()}function O(c){return p.fromISO(u.value.model.currentTime)<p.fromISO(c)}return(c,t)=>{const m=R("meta-no-seatbelts"),f=R("meta-list-card");return e(u)?(n(),l("div",rt,[a(f,{class:"tw-mb-4",title:"Subscription History",icon:"money-check-alt",itemList:U.value,sortOptions:q,emptyMessage:"No subscriptions... yet!","data-testid":"player-subscriptions-history-card"},{"item-card":s(({item:i})=>[a(e(tt),{extraMListItemMargin:""},{header:s(()=>[a(e(g),{noLeftPadding:""},{badge:s(()=>[O(i.expirationTime)?(n(),S(e(_),{key:0,variant:"success"},{default:s(()=>t[0]||(t[0]=[o("Active",-1)]),void 0,!0),_:1,__:[0]})):(n(),S(e(_),{key:1},{default:s(()=>t[1]||(t[1]=[o("Expired",-1)]),void 0,!0),_:1,__:[1]}))]),"top-right":s(()=>[a(e(y),{instant:e(p).fromISO(i.startTime),showAs:"dateTime"},null,8,["instant"])]),"bottom-left":s(()=>[i.latestInstanceIsDisabledDueToReuse?(n(),l("div",dt,"The subscription was disabled because it was used on another player account.")):w("",!0)]),"bottom-right":s(()=>[O(i.expirationTime)?(n(),l("div",ut,[i.renewalStatus==="ExpectedToRenew"?(n(),l("span",pt,[t[2]||(t[2]=o("Renewing ",-1)),a(e(y),{instant:e(p).fromISO(i.expirationTime)},null,8,["instant"])])):i.renewalStatus==="NotExpectedToRenew"?(n(),l("span",mt,[t[3]||(t[3]=o("Set to expire in ",-1)),a(e(y),{instant:e(p).fromISO(i.expirationTime)},null,8,["instant"])])):(n(),l("span",ct,"Unhandled renewal status: "+d(i.renewalStatus),1))])):(n(),l("div",ft,[t[4]||(t[4]=o("Expired ",-1)),a(e(y),{instant:e(p).fromISO(i.expirationTime)},null,8,["instant"])]))]),default:s(()=>[o(d(i.productId),1),h("span",lt,"$"+d(i.spend.toFixed(2)),1)],void 0,!0),_:2},1024)]),default:s(()=>[t[19]||(t[19]=h("div",{class:"font-weight-bold"},"Overview",-1)),a(e(K),{class:"tw-my-2",showBorder:"",striped:""},{default:s(()=>[a(e(g),{condensed:""},{"top-right":s(()=>[a(e(y),{instant:e(p).fromISO(i.startTime),showAs:"dateTime"},null,8,["instant"])]),default:s(()=>[t[5]||(t[5]=o("Start time",-1))],void 0,!0),_:2,__:[5]},1024),a(e(g),{condensed:""},{"top-right":s(()=>[a(e(y),{instant:e(p).fromISO(i.expirationTime),showAs:"dateTime"},null,8,["instant"])]),default:s(()=>[t[6]||(t[6]=o("Expiration time",-1))],void 0,!0),_:2,__:[6]},1024),a(e(g),{condensed:""},{"top-right":s(()=>[i.renewalStatus==="ExpectedToRenew"?(n(),S(e(_),{key:0,variant:"success"},{default:s(()=>t[7]||(t[7]=[o("On",-1)]),void 0,!0),_:1,__:[7]})):i.renewalStatus==="NotExpectedToRenew"?(n(),S(e(_),{key:1},{default:s(()=>t[8]||(t[8]=[o("Off",-1)]),void 0,!0),_:1,__:[8]})):(n(),l("span",vt,d(i.renewalStatus),1))]),default:s(()=>[t[9]||(t[9]=o("Auto-renewal status",-1))],void 0,!0),_:2,__:[9]},1024)],void 0,!0),_:2},1024),Object.keys(i.subscriptionInstances??{}).length>0?(n(),l("div",wt,[t[14]||(t[14]=o("Individual Subscriptions",-1)),a(e(K),{class:"tw-my-2",showBorder:"",striped:""},{default:s(()=>[(n(!0),l(L,null,C(i.subscriptionInstances,(r,v)=>(n(),S(e(g),{class:"tw-px-3",key:v,striped:""},{"top-right":s(()=>[O(r.lastKnownState.expirationTime)?(n(),S(e(_),{key:0,variant:"success"},{default:s(()=>t[10]||(t[10]=[o("Active",-1)]),void 0,!0),_:1,__:[10]})):(n(),S(e(_),{key:1},{default:s(()=>t[11]||(t[11]=[o("Expired",-1)]),void 0,!0),_:1,__:[11]}))]),"bottom-left":s(()=>[h("span",null,d(v),1),r.disabledDueToReuse?(n(),l("div",yt,[h("div",null,"The subscription was disabled because it was used on "+d(e(N)(r.otherPlayers.length,"other player account",!0))+":",1),(n(!0),l(L,null,C(r.otherPlayers,b=>(n(),l("div",null,[a(e(st),{to:`/players/${b}`},{default:s(()=>[o(d(b),1)],void 0,!0),_:2},1032,["to"])]))),256))])):w("",!0)]),"bottom-right":s(()=>[r.lastKnownState?(n(),l("div",St,[t[12]||(t[12]=o("Start: ",-1)),a(e(y),{instant:e(p).fromISO(r.lastKnownState.startTime)},null,8,["instant"])])):w("",!0),r.lastKnownState?(n(),l("div",_t,[t[13]||(t[13]=o("Expiry: ",-1)),a(e(y),{instant:e(p).fromISO(r.lastKnownState.expirationTime)},null,8,["instant"])])):w("",!0),r.lastKnownState?(n(),l("div",bt,"Periods: "+d(r.lastKnownState.numPeriods),1)):w("",!0)]),default:s(()=>[o(d(r.platform),1),a(e(et),{class:"tw-ml-1",content:r.spendExplanation},{default:s(()=>[o("$"+d(r.spend.toFixed(2)),1)],void 0,!0),_:2},1032,["content"])],void 0,!0),_:2},1024))),128))],void 0,!0),_:2},1024)])):w("",!0),h("div",ht,[H.value?(n(),S(e(at),{key:0,"modal-title":"Detach Subscription",action:()=>Q(i.productId),"trigger-button-label":"Detach Subscription",variant:"danger","ok-button-label":"Detach Subscription",permission:"api.players.remove_iap_subscription",onShow:r=>E.value=i},{default:s(()=>[h("p",null,[t[15]||(t[15]=o("You are about to detach the ",-1)),a(e(_),null,{default:s(()=>[o(d(E.value.productId),1)],void 0,!0),_:1}),t[16]||(t[16]=o(" subscription from ",-1)),a(e(_),null,{default:s(()=>[o(d(e(u).model.playerName),1)],void 0,!0),_:1}),t[17]||(t[17]=o(". This will also remove the related subscription IAP from the player's purchase history.",-1))]),t[18]||(t[18]=h("div",{class:"tw-text-xs+ tw-text-neutral-500"},"Players can re-activate their subscriptions by reclaiming IAPs from within the game. Detaching a subscription does not refund the purchase and instead is primarily a development-only tool.",-1)),a(m,{class:"tw-mt-4",name:e(u).model.playerName},null,8,["name"])],void 0,!0),_:2,__:[18]},1032,["action","onShow"])):w("",!0)])],void 0,!0),_:2,__:[19]},1024)]),_:1},8,["itemList"])])):w("",!0)}}});export{Pt as default};
